// Generated by CoffeeScript 1.10.0
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  define(['View/Grid', 'Commands/Command', 'Items/Divs/Div', 'mousewheel', 'tween'], function(Grid, Command, Div) {
    var View;
    View = (function() {
      function View() {
        this.mousewheel = bind(this.mousewheel, this);
        this.mouseup = bind(this.mouseup, this);
        this.mousemove = bind(this.mousemove, this);
        this.mousedown = bind(this.mousedown, this);
        this.onWindowResize = bind(this.onWindowResize, this);
        this.onFrame = bind(this.onFrame, this);
        this.onKeyUp = bind(this.onKeyUp, this);
        this.onKeyDown = bind(this.onKeyDown, this);
        this.onMouseUp = bind(this.onMouseUp, this);
        this.onMouseDrag = bind(this.onMouseDrag, this);
        this.onMouseDown = bind(this.onMouseDown, this);
        this.onHashChange = bind(this.onHashChange, this);
        this.updateHash = bind(this.updateHash, this);
        this.addMoveCommand = bind(this.addMoveCommand, this);
        R.stageJ = $("#stage");
        R.canvasJ = R.stageJ.find("#canvas");
        R.canvas = R.canvasJ[0];
        R.canvas.width = window.innerWidth;
        R.canvas.height = window.innerHeight;
        R.context = R.canvas.getContext('2d');
        paper.setup(R.canvas);
        R.project = P.project;
        this.mainLayer = P.project.activeLayer;
        this.mainLayer.name = 'main layer';
        this.debugLayer = new P.Layer();
        this.debugLayer.name = 'debug layer';
        this.carLayer = new P.Layer();
        this.carLayer.name = 'car layer';
        this.lockLayer = new P.Layer();
        this.lockLayer.name = 'lock layer';
        this.selectionLayer = new P.Layer();
        this.selectionLayer.name = 'selection layer';
        this.areasToUpdateLayer = new P.Layer();
        this.areasToUpdateLayer.name = 'areasToUpdateLayer';
        this.backgroundRectangle = null;
        this.areasToUpdateLayer.visible = false;
        this.mainLayer.activate();
        paper.settings.hitTolerance = 5;
        R.scale = 1000.0;
        P.view.zoom = 1;
        this.previousPosition = P.view.center;
        this.restrictedArea = null;
        this.entireArea = null;
        this.entireAreas = [];
        this.grid = new Grid();
        R.canvasJ.dblclick(function(event) {
          var ref;
          return (ref = R.selectedTool) != null ? typeof ref.doubleClick === "function" ? ref.doubleClick(event) : void 0 : void 0;
        });
        R.canvasJ.keydown(function(event) {
          if (event.key === 46) {
            event.preventDefault();
            return false;
          }
        });
        this.tool = new P.Tool();
        this.tool.onMouseDown = this.onMouseDown;
        this.tool.onMouseDrag = this.onMouseDrag;
        this.tool.onMouseUp = this.onMouseUp;
        this.tool.onKeyDown = this.onKeyDown;
        this.tool.onKeyUp = this.onKeyUp;
        P.view.onFrame = this.onFrame;
        R.stageJ.mousewheel(this.mousewheel);
        R.stageJ.mousedown(this.mousedown);
        $(window).mousemove(this.mousemove);
        $(window).mouseup(this.mouseup);
        $(window).resize(this.onWindowResize);
        window.onhashchange = this.onHashChange;
        this.mousePosition = new P.Point();
        this.previousMousePosition = null;
        this.initialMousePosition = null;
        return;
      }

      View.prototype.moveTo = function(pos, delay, addCommand) {
        var initialPosition, somethingToLoad, tween;
        if (addCommand == null) {
          addCommand = true;
        }
        if (pos == null) {
          pos = new P.Point();
        }
        if (delay == null) {
          somethingToLoad = this.moveBy(pos.subtract(P.view.center), addCommand);
        } else {
          initialPosition = P.view.center;
          tween = new TWEEN.Tween(initialPosition).to(pos, delay).easing(TWEEN.Easing.Exponential.InOut).onUpdate(function() {
            return this.moveTo(this, addCommand);
          }).start();
        }
        return somethingToLoad;
      };

      View.prototype.moveBy = function(delta, addCommand) {
        var area, div, i, j, len, len1, newEntireArea, newView, ref, ref1, restrictedAreaShrinked, somethingToLoad;
        if (addCommand == null) {
          addCommand = true;
        }
        if (this.restrictedArea != null) {
          if (!this.restrictedArea.contains(P.view.center)) {
            delta = this.restrictedArea.center.subtract(P.view.center);
          } else {
            newView = P.view.bounds.clone();
            newView.center.x += delta.x;
            newView.center.y += delta.y;
            if (!this.restrictedArea.contains(newView)) {
              restrictedAreaShrinked = this.restrictedArea.expand(P.view.size.multiply(-1));
              if (restrictedAreaShrinked.width < 0) {
                restrictedAreaShrinked.left = restrictedAreaShrinked.right = this.restrictedArea.center.x;
              }
              if (restrictedAreaShrinked.height < 0) {
                restrictedAreaShrinked.top = restrictedAreaShrinked.bottom = this.restrictedArea.center.y;
              }
              newView.center.x = Utils.clamp(restrictedAreaShrinked.left, newView.center.x, restrictedAreaShrinked.right);
              newView.center.y = Utils.clamp(restrictedAreaShrinked.top, newView.center.y, restrictedAreaShrinked.bottom);
              delta = newView.center.subtract(P.view.center);
            }
          }
        }
        if (this.previousPosition == null) {
          this.previousPosition = P.view.center;
        }
        P.view.scrollBy(new P.Point(delta.x, delta.y));
        ref = R.divs;
        for (i = 0, len = ref.length; i < len; i++) {
          div = ref[i];
          div.updateTransform();
        }
        R.rasterizer.move();
        this.grid.update();
        newEntireArea = null;
        ref1 = this.entireAreas;
        for (j = 0, len1 = ref1.length; j < len1; j++) {
          area = ref1[j];
          if (area.getBounds().contains(P.view.center)) {
            newEntireArea = area;
            break;
          }
        }
        if ((this.entireArea == null) && (newEntireArea != null)) {
          this.entireArea = newEntireArea.getBounds();
        } else if ((this.entireArea != null) && (newEntireArea == null)) {
          this.entireArea = null;
        }
        somethingToLoad = newEntireArea != null ? R.loader.load(this.entireArea) : R.loader.load();
        R.socket.updateRoom();
        Utils.deferredExecution(this.updateHash, 'updateHash', 500);
        if (addCommand) {
          Utils.deferredExecution(this.addMoveCommand, 'add move command');
        }
        R.controllerManager.folders['General'].controllers['location'].setValue('' + P.view.center.x.toFixed(2) + ',' + P.view.center.y.toFixed(2));
        return somethingToLoad;
      };

      View.prototype.addMoveCommand = function() {
        R.commandManager.add(new Command.MoveView(this.previousPosition, P.view.center));
        this.previousPosition = null;
      };

      View.prototype.updateHash = function() {
        var hashParameters;
        this.ignoreHashChange = true;
        hashParameters = {};
        if (R.repository.commit != null) {
          hashParameters['repository-owner'] = R.repository.owner;
          hashParameters['repository-commit'] = R.repository.commit;
        }
        if ((R.city.owner != null) && (R.city.name != null) && R.city.owner !== 'CommeUnDesseinOrg' && R.city.name !== 'CommeUnDessein') {
          hashParameters['city-owner'] = R.city.owner;
          hashParameters['city-name'] = R.city.name;
        }
        hashParameters['location'] = Utils.pointToString(P.view.center);
        location.hash = Utils.URL.setParameters(hashParameters);
      };

      View.prototype.setPositionFromString = function(positionString) {
        this.moveTo(Utils.stringToPoint(positionString));
      };

      View.prototype.onHashChange = function(event) {
        var p, parameters;
        if (this.ignoreHashChange) {
          this.ignoreHashChange = false;
          return;
        }
        parameters = Utils.URL.getParameters(document.location.hash);
        if ((R.repository.commit != null) && (R.repository.owner !== parameters['repository-owner'] || R.repository.commit !== parameters['repository-commit'])) {
          location.reload();
          return;
        }
        if (parameters['location'] != null) {
          p = Utils.stringToPoint(parameters['location']);
        }
        this.moveTo(p);
      };

      View.prototype.initializePosition = function() {
        var boxRectangle, br, controller, folder, folderName, i, len, planet, pos, ref, ref1, site, siteString, tl;
        R.city = {
          owner: R.canvasJ.attr("data-owner") !== '' ? R.canvasJ.attr("data-owner") : void 0,
          city: R.canvasJ.attr("data-city") !== '' ? R.canvasJ.attr("data-city") : void 0,
          site: R.canvasJ.attr("data-site") !== '' ? R.canvasJ.attr("data-site") : void 0
        };
        if (R.loadedBox == null) {
          window.onhashchange();
          return;
        }
        planet = new P.Point(R.loadedBox.planetX, R.loadedBox.planetY);
        tl = Utils.CS.posOnPlanetToProject(R.loadedBox.box.coordinates[0][0], planet);
        br = Utils.CS.posOnPlanetToProject(R.loadedBox.box.coordinates[0][2], planet);
        boxRectangle = new P.Rectangle(tl, br);
        pos = boxRectangle.center;
        this.moveTo(pos);
        if (R.loadEntireArea) {
          this.entireArea = boxRectangle;
          R.loader.load(boxRectangle);
        }
        siteString = R.canvasJ.attr("data-site");
        site = JSON.parse(siteString);
        if (site.restrictedArea) {
          this.restrictedArea = boxRectangle;
        }
        R.tools.select.select();
        if (site.disableToolbar) {
          R.sidebar.hide();
        } else {
          R.sidebar.sidebarJ.find("div.panel.panel-default:not(:last)").hide();
          ref = R.gui.__folders;
          for (folderName in ref) {
            folder = ref[folderName];
            ref1 = folder.__controllers;
            for (i = 0, len = ref1.length; i < len; i++) {
              controller = ref1[i];
              if (controller.name !== 'Zoom') {
                folder.remove(controller);
                folder.__controllers.remove(controller);
              }
            }
            if (folder.__controllers.length === 0) {
              R.gui.removeFolder(folderName);
            }
          }
          R.sidebar.handleJ.click();
        }
      };

      View.prototype.focusIsOnCanvas = function() {
        return $(document.activeElement).is("body");
      };

      View.prototype.onMouseDown = function(event) {
        var ref, ref1;
        if ((ref = R.wacomPenAPI) != null ? ref.isEraser : void 0) {
          this.tool.onKeyUp({
            key: 'delete'
          });
          return;
        }
        $(document.activeElement).blur();
        if ((ref1 = R.selectedTool) != null) {
          ref1.begin(event);
        }
      };

      View.prototype.onMouseDrag = function(event) {
        var ref, ref1;
        if ((ref = R.wacomPenAPI) != null ? ref.isEraser : void 0) {
          return;
        }
        if (R.currentDiv != null) {
          return;
        }
        if ((ref1 = R.selectedTool) != null) {
          ref1.update(event);
        }
      };

      View.prototype.onMouseUp = function(event) {
        var ref, ref1;
        if ((ref = R.wacomPenAPI) != null ? ref.isEraser : void 0) {
          return;
        }
        if (R.currentDiv != null) {
          return;
        }
        if ((ref1 = R.selectedTool) != null) {
          ref1.end(event);
        }
      };

      View.prototype.onKeyDown = function(event) {
        var ref;
        if (!this.focusIsOnCanvas()) {
          return;
        }
        if (event.key === 'delete') {
          event.preventDefault();
          return false;
        }
        if (event.key === 'space' && ((ref = R.selectedTool) != null ? ref.name : void 0) !== 'Move') {
          R.tools.move.select();
        }
      };

      View.prototype.onKeyUp = function(event) {
        var ref, ref1;
        if (!this.focusIsOnCanvas()) {
          return;
        }
        if ((ref = R.selectedTool) != null) {
          ref.keyUp(event);
        }
        switch (event.key) {
          case 'space':
            if ((ref1 = R.previousTool) != null) {
              ref1.select();
            }
            break;
          case 'v':
            R.tools.select.select();
            break;
          case 't':
            R.showToolBox();
            break;
          case 'r':
            if (event.modifiers.shift) {
              R.rasterizer.rasterizeImmediately();
            }
        }
        event.preventDefault();
      };

      View.prototype.onFrame = function(event) {
        var base, i, item, len, ref, ref1;
        TWEEN.update(event.time);
        if (typeof (base = R.rasterizer).updateLoadingBar === "function") {
          base.updateLoadingBar(event.time);
        }
        if ((ref = R.selectedTool) != null) {
          if (typeof ref.onFrame === "function") {
            ref.onFrame(event);
          }
        }
        ref1 = R.animatedItems;
        for (i = 0, len = ref1.length; i < len; i++) {
          item = ref1[i];
          item.onFrame(event);
        }
      };

      View.prototype.onWindowResize = function(event) {
        this.grid.update();
        $(".mCustomScrollbar").mCustomScrollbar("update");
        P.view.update();
        R.canvasJ.width(window.innerWidth);
        R.canvasJ.height(window.innerHeight);
        P.view.viewSize = new P.Size(window.innerWidth, window.innerHeight);
      };

      View.prototype.mousedown = function(event) {
        var ref, ref1, ref2;
        switch (event.which) {
          case 2:
            R.tools.move.select();
            break;
          case 3:
            if ((ref = R.selectedTool) != null) {
              if (typeof ref.finish === "function") {
                ref.finish();
              }
            }
        }
        if (((ref1 = R.selectedTool) != null ? ref1.name : void 0) === 'Move') {
          if ((ref2 = R.selectedTool) != null) {
            ref2.beginNative(event);
          }
          return;
        }
        this.initialMousePosition = Utils.Event.jEventToPoint(event);
        this.previousMousePosition = this.initialMousePosition.clone();
      };

      View.prototype.mousemove = function(event) {
        var base, paperEvent, ref, ref1, ref2;
        this.mousePosition.x = event.pageX;
        this.mousePosition.y = event.pageY;
        if (((ref = R.selectedTool) != null ? ref.name : void 0) === 'Move' && R.selectedTool.dragging) {
          R.selectedTool.updateNative(event);
          return;
        }
        Div.updateHiddenDivs(event);
        if ((ref1 = R.codeEditor) != null) {
          ref1.onMouseMove(event);
        }
        if ((ref2 = R.drawingPanel) != null) {
          ref2.onMouseMove(event);
        }
        if (R.currentDiv != null) {
          paperEvent = Utils.Event.jEventToPaperEvent(event, this.previousMousePosition, this.initialMousePosition, 'mousemove');
          if (typeof (base = R.currentDiv).updateSelect === "function") {
            base.updateSelect(paperEvent);
          }
          this.previousMousePosition = paperEvent.point;
        }
      };

      View.prototype.mouseup = function(event) {
        var base, paperEvent, ref, ref1, ref2, ref3;
        if (R.stageJ.hasClass("has-tool-box") && !$(event.target).parents('.tool-box').length > 0) {
          R.hideToolBox();
        }
        if ((ref = R.codeEditor) != null) {
          ref.onMouseUp(event);
        }
        if ((ref1 = R.drawingPanel) != null) {
          ref1.onMouseUp(event);
        }
        if (((ref2 = R.selectedTool) != null ? ref2.name : void 0) === 'Move') {
          R.selectedTool.endNative(event);
          if (event.which === 2) {
            if ((ref3 = R.previousTool) != null) {
              ref3.select();
            }
          }
          return;
        }
        if (R.currentDiv != null) {
          paperEvent = Utils.Event.jEventToPaperEvent(event, this.previousMousePosition, this.initialMousePosition, 'mouseup');
          if (typeof (base = R.currentDiv).endSelect === "function") {
            base.endSelect(paperEvent);
          }
          this.previousMousePosition = paperEvent.point;
        }
      };

      View.prototype.mousewheel = function(event) {
        this.moveBy(new P.Point(-event.deltaX, event.deltaY));
      };

      return View;

    })();
    return View;
  });

}).call(this);
