// Generated by CoffeeScript 1.10.0
(function() {
  var bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  define(['paper', 'R', 'Utils/Utils', 'UI/Modal', 'i18next'], function(P, R, Utils, Modal, i18next) {
    var CityManager;
    CityManager = (function() {
      function CityManager() {
        this.deleteCityCallback = bind(this.deleteCityCallback, this);
        this.deleteCity = bind(this.deleteCity, this);
        this.updateCityCallback = bind(this.updateCityCallback, this);
        this.updateCity = bind(this.updateCity, this);
        this.openCitySettings = bind(this.openCitySettings, this);
        this.onCityClicked = bind(this.onCityClicked, this);
        this.addCities = bind(this.addCities, this);
        this.createCityModal = bind(this.createCityModal, this);
        this.createCityCallback = bind(this.createCityCallback, this);
        this.createCity = bind(this.createCity, this);
        this.cityPanelJ = $('#City');
        this.citiesListsJ = this.cityPanelJ.find('.city-list');
        this.userCitiesJ = this.cityPanelJ.find('.user-cities');
        this.publicCitiesJ = this.cityPanelJ.find('.public-cities');
        this.createCityBtnJ = this.cityPanelJ.find('.create-city');
        this.citiesListBtnJ = this.cityPanelJ.find('.load-city');
        this.createCityBtnJ.click(this.createCityModal);
        this.citiesListBtnJ.click(this.citiesModal);
        if (R.offline) {
          return;
        }
        $.ajax({
          method: "POST",
          url: "ajaxCall/",
          data: {
            data: JSON.stringify({
              "function": 'loadCities',
              args: {}
            })
          }
        }).done(this.addCities);
        return;
      }

      CityManager.prototype.createCity = function(data) {
        $.ajax({
          method: "POST",
          url: "ajaxCall/",
          data: {
            data: JSON.stringify({
              "function": 'createCity',
              args: {
                name: data.name,
                "public": data["public"]
              }
            })
          }
        }).done(this.createCityCallback);
      };

      CityManager.prototype.createCityCallback = function(result) {
        var city, modal;
        modal = Modal.getModalByTitle('Create city');
        if (modal != null) {
          modal.hide();
        }
        if (!R.loader.checkError(result)) {
          return;
        }
        city = JSON.parse(result.city);
        this.addCity(city, true);
        this.loadCity(city.name, city.owner);
      };

      CityManager.prototype.createCityModal = function() {
        var modal;
        modal = Modal.createModal({
          title: 'Create city',
          submit: this.createCity,
          postSubmit: 'load'
        });
        modal.addTextInput({
          label: "City name",
          name: 'name',
          required: true,
          submitShortcut: true,
          placeholder: 'Paris'
        });
        modal.addCheckbox({
          label: "Public",
          name: 'public',
          helpMessage: "Public cities will be accessible by anyone.",
          defaultValue: true
        });
        modal.show();
      };

      CityManager.prototype.addCity = function(city, userCity) {
        var btnJ, cityJ;
        cityJ = $("<li>");
        cityJ.append($('<span>').addClass('name').attr('data-i18n', city.name).text(i18next.t(city.name)));
        cityJ.attr('data-owner', city.owner).attr('data-pk', city._id.$oid).attr('data-public', city["public"] || 0).attr('data-name', city.name);
        cityJ.click(this.onCityClicked);
        if (userCity) {
          btnJ = $('<button type="button"><span class="glyphicon glyphicon-cog" aria-hidden="true"></span></button>');
          btnJ.click(this.openCitySettings);
          cityJ.append(btnJ);
          this.userCitiesJ.append(cityJ);
        } else {
          this.publicCitiesJ.append(cityJ);
        }
      };

      CityManager.prototype.addCities = function(result) {
        var cities, city, i, j, k, len, len1, publicCities, ref, userCities, userCity;
        if (!R.loader.checkError(result)) {
          return;
        }
        userCities = JSON.parse(result.userCities);
        publicCities = JSON.parse(result.publicCities);
        ref = [userCities, publicCities];
        for (i = j = 0, len = ref.length; j < len; i = ++j) {
          cities = ref[i];
          userCity = i === 0;
          for (k = 0, len1 = cities.length; k < len1; k++) {
            city = cities[k];
            this.addCity(city, userCity);
          }
        }
      };

      CityManager.prototype.onCityClicked = function(event) {
        var name, owner, parentJ;
        parentJ = $(event.target).closest('li');
        name = parentJ.attr('data-name');
        owner = parentJ.attr('data-owner');
        this.loadCity(name, owner);
      };

      CityManager.prototype.loadCity = function(name, owner) {
        R.loader.unload();
        R.city = {
          owner: owner,
          name: name,
          site: null
        };
        R.drawingMode = name === 'pixel' || name === 'ortho' || name === 'orthoDiag' || name === 'image' || name === 'line' || name === 'lineOrthoDiag' ? name : null;
        R.loader.load();
        R.view.updateHash();
        R.view.createBackground();
      };

      CityManager.prototype.openCitySettings = function(event) {
        var isPublic, liJ, modal, name, pk;
        event.stopPropagation();
        liJ = $(event.target).closest('li');
        name = liJ.attr('data-name');
        isPublic = parseInt(liJ.attr('data-public'));
        pk = liJ.attr('data-pk');
        modal = Modal.createModal({
          title: 'Modify city',
          submit: this.updateCity,
          data: {
            pk: pk,
            name: name
          },
          postSubmit: 'load'
        });
        modal.addTextInput({
          name: 'name',
          label: 'Name',
          defaultValue: name,
          required: true,
          submitShortcut: true
        });
        modal.addCheckbox({
          name: 'public',
          label: 'Public',
          helpMessage: "Public cities will be accessible by anyone.",
          defaultValue: isPublic
        });
        modal.addButton({
          name: 'Delete',
          type: 'danger',
          submit: this.deleteCity
        });
        modal.show();
      };

      CityManager.prototype.updateCity = function(data) {
        if (R.city.name === data.data.name) {
          this.modifyingCurrentCity = true;
        }
        $.ajax({
          method: "POST",
          url: "ajaxCall/",
          data: {
            data: JSON.stringify({
              "function": 'updateCity',
              args: {
                pk: data.data.pk,
                name: data.name,
                "public": data["public"]
              }
            })
          }
        }).done(this.updateCityCallback);
      };

      CityManager.prototype.updateCityCallback = function(result) {
        var city, cityJ, modal;
        modal = Modal.getModalByTitle('Modify city');
        modal.hide();
        if (!R.loader.checkError(result)) {
          this.modifyingCurrentCity = false;
          return;
        }
        city = JSON.parse(result.city);
        if (this.modifyingCurrentCity) {
          R.city.name = city.name;
          R.city.owner = city.owner;
          R.view.updateHash();
          this.modifyingCurrentCity = false;
        }
        cityJ = this.citiesListsJ.find('li[data-pk="' + city._id.$oid + '"]');
        cityJ.attr('data-name', city.name);
        cityJ.attr('data-public', Number(city["public"] || 0));
        cityJ.attr('data-content', 'by ' + city.owner);
        cityJ.find('.name').text(city.name);
      };

      CityManager.prototype.deleteCity = function(data) {
        $.ajax({
          method: "POST",
          url: "ajaxCall/",
          data: {
            data: JSON.stringify({
              "function": 'deleteCity',
              args: {
                name: data.data.name
              }
            })
          }
        }).done(this.deleteCityCallback);
      };

      CityManager.prototype.deleteCityCallback = function(result) {
        if (!R.loader.checkError(result)) {
          return;
        }
        this.citiesListsJ.find('li[data-pk="' + result.cityPk + '"]').remove();
      };

      return CityManager;

    })();
    return CityManager;
  });

}).call(this);
